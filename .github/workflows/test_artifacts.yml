name: Test Artifact System

on: [workflow_dispatch]

jobs:
  test-artifacts:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install pandas
      run: pip install pandas
    
    - name: Create test script
      run: |
        cat > test_artifacts.py << 'EOF'
        import os
        import pandas as pd
        
        print("ğŸ§ª Testing Historical Data Artifacts")
        print("=" * 50)
        
        processed_dir = "data/processed"
        
        # Check if directory exists
        if not os.path.exists(processed_dir):
            print(f"âŒ Directory '{processed_dir}' does not exist!")
            print("This is normal for first run or if artifact hasn't been created yet.")
            exit(0)  # Exit with success code, not error
        
        print(f"âœ… Directory exists: {processed_dir}")
        
        # List all files
        all_files = os.listdir(processed_dir)
        print(f"\nğŸ“ Files in directory: {len(all_files)} files")
        
        csv_files = [f for f in all_files if f.endswith('.csv')]
        txt_files = [f for f in all_files if f.endswith('.txt')]
        
        print(f"ğŸ“Š CSV files: {len(csv_files)}")
        print(f"ğŸ“„ TXT files: {len(txt_files)}")
        
        if csv_files:
            print("\nğŸ” CSV File Details:")
            for csv_file in sorted(csv_files):
                filepath = os.path.join(processed_dir, csv_file)
                try:
                    # Read just the first row to check structure
                    df_sample = pd.read_csv(filepath, nrows=1)
                    size_mb = os.path.getsize(filepath) / (1024 * 1024)
                    
                    print(f"\n  ğŸ“ File: {csv_file}")
                    print(f"    Size: {size_mb:.2f} MB")
                    print(f"    Columns: {len(df_sample.columns)}")
                    
                    # Check for required columns
                    required_cols = ['instrument_type', 'symbol', 'lastPrice']
                    missing = [col for col in required_cols if col not in df_sample.columns]
                    if missing:
                        print(f"    âš ï¸ Missing columns: {missing}")
                    else:
                        print(f"    âœ… Required columns present")
                    
                    # Check date in filename
                    if csv_file.startswith('nse_fo_'):
                        date_str = csv_file.replace('nse_fo_', '').replace('.csv', '')
                        print(f"    Date in filename: {date_str}")
                        
                except Exception as e:
                    print(f"    âŒ Error reading {csv_file}: {str(e)[:100]}")
        
        print("\n" + "=" * 50)
        print("âœ… Test completed successfully!")
        EOF
    
    - name: Try to download artifact
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: nse-historical-data  # CORRECTED NAME
        path: data/processed/
    
    - name: Run test script
      run: python test_artifacts.py
    
    - name: List what was downloaded
      run: |
        echo "=== Downloaded Artifact Contents ==="
        if [ -d "data/processed" ]; then
          find data/processed -type f | sort || echo "No files found"
        else
          echo "No artifact was downloaded (this is normal for first run)"
        fi
