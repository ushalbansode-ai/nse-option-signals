name: Daily NSE Option Analysis

on:
  schedule:
    - cron: '30 8 * * 1-5'  # Runs at 2:00 PM IST (8:30 UTC) on weekdays
  workflow_dispatch:         # Manual trigger

jobs:
  run-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests yfinance datetime python-dotenv
    
    - name: Create directories
      run: |
        mkdir -p data/raw
        mkdir -p data/processed
        mkdir -p data/comparison
        mkdir -p outputs/signals
        mkdir -p outputs/reports
        mkdir -p logs
        echo "âœ… Directories created successfully"
    
    - name: Download historical data (from previous run)
      uses: dawidd6/action-download-artifact@v6
      continue-on-error: true
      with:
        workflow: daily_option_analysis.yml
        name: nse-historical-data
        path: data/processed/
    
    - name: Check existing historical data
      run: |
        echo "=== Checking Historical Data ==="
        echo ""
        echo "ðŸ“Š Historical files found:"
        if [ -d "data/processed" ]; then
          count=$(find data/processed -name "*.csv" -type f | wc -l)
          if [ $count -gt 0 ]; then
            echo "âœ… Found $count historical CSV files"
            echo ""
            echo "ðŸ“ Files:"
            ls -la data/processed/*.csv 2>/dev/null || echo "No CSV files"
            echo ""
            echo "ðŸ“… Latest file dates:"
            for file in data/processed/*.csv; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "- $filename: $(stat -c %y "$file" 2>/dev/null | cut -d' ' -f1)"
              fi
            done
          else
            echo "âš ï¸ No historical CSV files found (first run?)"
          fi
        else
          echo "âŒ data/processed directory not found"
        fi
    
    - name: Run main analysis script
      run: python run.py
      continue-on-error: false
    
    - name: Compare with yesterday's data
      run: |
        echo "=== Comparing Today vs Yesterday ==="
        echo ""
        
        # Get today's date
        TODAY=$(date +'%Y-%m-%d')
        YESTERDAY=$(date -d "yesterday" +'%Y-%m-%d')
        
        echo "ðŸ“… Today: $TODAY"
        echo "ðŸ“… Yesterday: $YESTERDAY"
        echo ""
        
        # Check if we have yesterday's data
        YESTERDAY_FILE=$(find data/processed -name "*${YESTERDAY}*.csv" -type f | head -1)
        
        if [ -f "$YESTERDAY_FILE" ]; then
          echo "âœ… Found yesterday's data: $(basename $YESTERDAY_FILE)"
          echo ""
          
          # Find today's new data
          TODAY_FILES=$(find data/processed -name "*${TODAY}*.csv" -type f)
          
          if [ -n "$TODAY_FILES" ]; then
            echo "âœ… Found today's data"
            
            # Create comparison directory
            mkdir -p data/comparison
            
            # Run comparison logic (you can customize this)
            echo "Running comparison analysis..."
            
            # Example: Create a simple comparison report
            python3 -c "
import pandas as pd
import os
from datetime import datetime

# Get today and yesterday dates
today = pd.Timestamp('$TODAY')
yesterday = pd.Timestamp('$YESTERDAY')

# Look for data files
today_files = [f for f in os.listdir('data/processed') if '$TODAY' in f and f.endswith('.csv')]
yesterday_files = [f for f in os.listdir('data/processed') if '$YESTERDAY' in f and f.endswith('.csv')]

if today_files and yesterday_files:
    # Read data (simplified - you should adjust based on your data structure)
    try:
        # Try to read the first file of each day
        df_today = pd.read_csv(f'data/processed/{today_files[0]}')
        df_yesterday = pd.read_csv(f'data/processed/{yesterday_files[0]}')
        
        # Basic comparison
        comparison_report = []
        comparison_report.append('=== NSE DATA COMPARISON REPORT ===')
        comparison_report.append(f'Date: {today.date()}')
        comparison_report.append(f'Comparing: {yesterday.date()} â†’ {today.date()}')
        comparison_report.append('')
        comparison_report.append(f'Today\'s records: {len(df_today)}')
        comparison_report.append(f'Yesterday\'s records: {len(df_yesterday)}')
        comparison_report.append(f'Change: {len(df_today) - len(df_yesterday)} records')
        
        # Save comparison report
        with open('outputs/comparison_report.txt', 'w') as f:
            f.write('\n'.join(comparison_report))
        
        print('âœ… Comparison report generated')
        
        # Generate signals based on comparison
        signals = []
        signals.append('=== SIGNALS GENERATED ===')
        signals.append(f'Generated at: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
        signals.append('')
        
        # Example signal logic (customize based on your data)
        if len(df_today) > len(df_yesterday):
            signals.append('ðŸ“ˆ SIGNAL: Increased data volume detected')
            signals.append('   Action: Consider bullish positions')
        elif len(df_today) < len(df_yesterday):
            signals.append('ðŸ“‰ SIGNAL: Decreased data volume detected')
            signals.append('   Action: Consider bearish positions')
        else:
            signals.append('ðŸ“Š SIGNAL: Stable data volume')
            signals.append('   Action: Maintain current positions')
        
        # Save signals
        with open('outputs/signals/daily_signals.txt', 'w') as f:
            f.write('\n'.join(signals))
        
        print('âœ… Signals generated')
        
    except Exception as e:
        print(f'âŒ Error in comparison: {e}')
else:
    print('âš ï¸ Missing data files for comparison')
"
          else
            echo "âš ï¸ No today's data found for comparison"
          fi
        else
          echo "âš ï¸ No yesterday's data found for comparison (first day?)"
        fi
    
    - name: Upload historical data artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: nse-historical-data
        path: data/processed/
        retention-days: 90
        if-no-files-found: error
    
    - name: Upload reports artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: nse-analysis-reports
        path: outputs/
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload comparison results
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: nse-comparison-results
        path: data/comparison/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Summary and logs
      run: |
        echo "=== ANALYSIS COMPLETE ==="
        echo ""
        echo "ðŸ“Š Artifacts Generated:"
        echo "1. nse-historical-data - Historical CSV files"
        echo "2. nse-analysis-reports - Analysis reports"
        echo "3. nse-comparison-results - Day-over-day comparison"
        echo ""
        echo "ðŸ“ˆ Signals Generated:"
        if [ -f "outputs/signals/daily_signals.txt" ]; then
          cat outputs/signals/daily_signals.txt
        else
          echo "No signals file found"
        fi
        echo ""
        echo "ðŸ“ Files Created:"
        find outputs/ -type f | sort || echo "No output files"
        echo ""
        echo "â° Next Run: Tomorrow at 2:00 PM IST"
        echo ""
        echo "âœ… Workflow completed successfully"
    
    - name: Commit and push results
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are any changes in outputs/
        if git diff --quiet -- outputs/; then
          echo "âœ… No changes in outputs to commit"
        else
          echo "ðŸ“ Committing changes..."
          git add outputs/
          git commit -m "Update NSE analysis reports and signals $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          
          # Push changes
          echo "ðŸš€ Pushing changes..."
          git push || echo "Push failed or no changes"
        fi
